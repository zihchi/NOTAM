<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini NOTAM Radar - å°ˆæ¥­èˆªæƒ…åˆ†æå·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: calc(100vh - 350px); min-height: 450px; }
        .leaflet-popup-content { font-family: 'Monaco', 'Consolas', monospace; font-size: 13px; line-height: 1.5; }
        .notam-table th { @apply bg-slate-100 p-2 text-left text-xs font-bold text-slate-600 border; }
        .notam-table td { @apply p-2 text-xs border border-slate-200; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">

    <div class="max-w-7xl mx-auto px-4 py-6">
        <header class="mb-6 flex justify-between items-end border-b-2 border-blue-600 pb-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">Gemini <span class="text-blue-600">NOTAM</span> Radar</h1>
                <p class="text-slate-500 mt-1 font-medium">èˆªç©ºå…¬å‘Šè¦–è¦ºåŒ–è§£æå¼•æ“ <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded ml-2">æ¸¬è©¦ä¸­</span></p>
            </div>
            <div class="text-right">
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">NOTAM MAP </div>
                <div id="clock" class="text-sm font-mono text-blue-600 font-bold"></div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-6">
            <!-- å·¦å´æ§åˆ¶å€ -->
            <div class="lg:col-span-4 space-y-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <label class="block text-sm font-bold mb-3 text-slate-700 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        è²¼å…¥ NOTAM / AIP åŸå§‹æ–‡æœ¬
                    </label>
                    <textarea id="notamInput" 
                        class="w-full h-64 p-4 text-sm font-mono border border-slate-200 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 focus:outline-none bg-slate-50 transition-all"
                        placeholder="ä¾‹å¦‚: &#10;A1234/24 NOTAMN&#10;Q) RJJJ/QWLW/IV/M/W/000/040/&#10;B) 2412250100 C) 2412250400&#10;E) ACFT ACROBATIC FLT AREA:&#10;351234N1394567E ..."></textarea>
                    
                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <button onclick="processData()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition shadow-lg shadow-blue-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                            é›·é”æƒæåˆ†æ
                        </button>
                        <button onclick="clearAll()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 px-4 rounded-xl transition">
                            æ¸…ç©ºé‡ç½®
                        </button>
                    </div>
                </div>

                <!-- è³‡è¨Šæ‘˜è¦å€ -->
                <div id="notamInfo" class="hidden bg-white p-5 rounded-2xl shadow-sm border border-slate-200 animate-fade-in">
                    <h3 class="text-sm font-bold text-slate-800 mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        èˆªæƒ…æ‘˜è¦åˆ†æ
                    </h3>
                    <div id="infoContent" class="space-y-3"></div>
                </div>
            </div>

            <!-- å³å´åœ°åœ–å€ -->
            <div class="lg:col-span-8 relative">
                <div id="map" class="rounded-2xl shadow-inner border border-slate-200 overflow-hidden z-10"></div>
                <div class="absolute top-4 right-4 z-[1000] space-y-2">
                    <div class="bg-white/90 backdrop-blur p-3 rounded-xl shadow-sm border border-slate-200 text-[11px]">
                        <div class="flex items-center mb-1"><span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>å¤šé‚Šå½¢å€åŸŸ (Polygon)</div>
                        <div class="flex items-center"><span class="w-3 h-3 bg-emerald-500 rounded-full mr-2"></span>åŠå¾‘ç¯„åœ (Radius)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•¸æ“šè¡¨æ ¼å€ -->
        <div id="logArea" class="hidden space-y-4 animate-fade-in">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
                <h3 class="text-sm font-bold mb-4 flex items-center text-slate-700">
                    <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H5a2 2 0 01-2-2V5a2 2 0 012-2h11.282a2 2 0 011.414.586l4.707 4.707A2 2 0 0121 11.718V17a2 2 0 01-2 2z"></path></svg>
                    æå–åº§æ¨™æ¸…å–® (Decimals)
                </h3>
                <div id="coordList" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3"></div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–åœ°åœ– (é è¨­å°ç£èˆ‡æ—¥æœ¬ä¸­é–“æµ·åŸŸ)
        const map = L.map('map', { zoomControl: false }).setView([25.03, 121.5], 6);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        let activeLayers = [];

        // æ›´æ–°æ™‚é–“
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = `UTC: ${now.toISOString().replace('T', ' ').slice(0, 19)}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // æ ¸å¿ƒè§£æé‚è¼¯ï¼šå°‡èˆªç”¨åº§æ¨™è½‰ç‚ºåé€²åˆ¶
        function smartToDec(val) {
            if (!val) return NaN;
            const dirMatch = val.match(/[NSEW]/i);
            if (!dirMatch) return NaN;
            
            const dir = dirMatch[0].toUpperCase();
            const nums = val.replace(/[NSEW]/i, "").trim();
            
            let d, m, s;
            if (dir === 'N' || dir === 'S') {
                // è™•ç† N351234 æˆ– N351234.55
                d = nums.slice(0, 2);
                m = nums.slice(2, 4);
                s = nums.slice(4) || "0";
            } else {
                // è™•ç† E1391234 æˆ– E1391234.55
                d = nums.slice(0, 3);
                m = nums.slice(3, 5);
                s = nums.slice(5) || "0";
            }
            
            let dec = parseFloat(d) + parseFloat(m)/60 + parseFloat(s)/3600;
            return (dir === 'S' || dir === 'W') ? -dec : dec;
        }

        // è§£æ NOTAM è³‡è¨Š (ç·¨è™Ÿã€æ™‚é–“)
        function parseNotamHeader(text) {
            const idMatch = text.match(/([A-Z]\d{4}\/\d{2})/);
            const timeMatchB = text.match(/B\)\s*(\d{10})/);
            const timeMatchC = text.match(/C\)\s*(\d{10}|PERM|EST)/);
            
            const formatTime = (ts) => {
                if (!ts || ts.length < 10) return ts;
                const year = "20" + ts.slice(0, 2);
                const month = ts.slice(2, 4);
                const day = ts.slice(4, 6);
                const hour = ts.slice(6, 8);
                const min = ts.slice(8, 10);
                const utcDate = new Date(`${year}-${month}-${day}T${hour}:${min}:00Z`);
                const localDate = new Date(utcDate.getTime() + (9 * 60 * 60 * 1000)); // é è¨­ JST+9
                return {
                    utc: `${year}/${month}/${day} ${hour}:${min} UTC`,
                    local: `${localDate.getFullYear()}/${(localDate.getMonth()+1).toString().padStart(2,'0')}/${localDate.getDate().toString().padStart(2,'0')} ${localDate.getHours().toString().padStart(2,'0')}:${localDate.getMinutes().toString().padStart(2,'0')} (Local)`
                };
            };

            return {
                id: idMatch ? idMatch[1] : "æœªçŸ¥åç·¨è™Ÿ",
                start: timeMatchB ? formatTime(timeMatchB[1]) : null,
                end: timeMatchC ? formatTime(timeMatchC[1]) : null
            };
        }

        function parseCoordinates(text) {
            const cleanText = text.replace(/[\t\r\n]+/g, " ");
            let results = [];
            
            // å¼·åŒ–å‹é€£å¯«åº§æ¨™æ­£å‰‡ (æ”¯æ´å°æ•¸é»)
            const universalPattern = /([NS]\s*\d{4,}(?:\.\d+)?|\d{4,}(?:\.\d+)?[NS])[\s/]*([EW]\s*\d{5,}(?:\.\d+)?|\d{5,}(?:\.\d+)?[EW])/gi;
            let m;
            while ((m = universalPattern.exec(cleanText)) !== null) {
                const lat = smartToDec(m[1]);
                const lng = smartToDec(m[2]);
                if (!isNaN(lat) && !isNaN(lng)) results.push([lat, lng]);
            }

            // ç¬¦è™Ÿå‹åº§æ¨™æ­£å‰‡ (åº¦åˆ†ç§’)
            if (results.length === 0) {
                const symRegex = /([NS])\s*(\d{1,2})[Â°\s](\d{2})['â€™\s](\d{2}(?:\.\d+)?)[â€"\s]*([EW])\s*(\d{1,3})[Â°\s](\d{2})['â€™\s](\d{2}(?:\.\d+)?)/gi;
                while ((m = symRegex.exec(cleanText)) !== null) {
                    results.push([
                        parseFloat(m[2]) + parseFloat(m[3])/60 + parseFloat(m[4])/3600 * (m[1].toUpperCase()==='S'?-1:1),
                        parseFloat(m[6]) + parseFloat(m[7])/60 + parseFloat(m[8])/3600 * (m[5].toUpperCase()==='W'?-1:1)
                    ]);
                }
            }
            return results;
        }

        function processData() {
            const input = document.getElementById('notamInput').value;
            if (!input.trim()) return;

            // æ¸…é™¤èˆŠåœ–å±¤
            activeLayers.forEach(l => map.removeLayer(l));
            activeLayers = [];

            const headerInfo = parseNotamHeader(input);
            const blocks = input.split(/(?=\d\.\s*FLT AREA|AREA\s+\d+|1\.THE AREA)/i);
            let allCoords = [];

            blocks.forEach((block, index) => {
                const coords = parseCoordinates(block);
                if (coords.length === 0) return;
                allCoords = allCoords.concat(coords);

                const cleanBlock = block.replace(/\s+/g, " ");
                const radiusMatch = cleanBlock.match(/(\d+(?:\.\d+)?)\s*(NM|KM)\s*RADIUS/i) || 
                                   cleanBlock.match(/RADIUS\s+(?:OF\s+)?(\d+(?:\.\d+)?)\s*(NM|KM)/i);

                if (radiusMatch) {
                    const rValue = parseFloat(radiusMatch[1]);
                    const rUnit = radiusMatch[2].toUpperCase();
                    const meters = rValue * (rUnit === "NM" ? 1852 : 1000);
                    
                    const circle = L.circle(coords[0], {
                        color: '#10b981',
                        fillColor: '#10b981',
                        fillOpacity: 0.25,
                        radius: meters,
                        weight: 2,
                        dashArray: '5, 5'
                    }).addTo(map);
                    activeLayers.push(circle);
                    circle.bindPopup(`<b>Radius Area</b><br>ä¸­å¿ƒ: ${coords[0][0].toFixed(4)}, ${coords[0][1].toFixed(4)}<br>åŠå¾‘: ${rValue} ${rUnit}`);
                } else if (coords.length >= 3) {
                    const poly = L.polygon(coords, {
                        color: '#2563eb',
                        fillColor: '#3b82f6',
                        fillOpacity: 0.2,
                        weight: 3
                    }).addTo(map);
                    activeLayers.push(poly);
                    poly.bindPopup(`<b>Polygon Area</b><br>é ‚é»æ•¸: ${coords.length}`);
                } else {
                    coords.forEach(c => {
                        const marker = L.circleMarker(c, { radius: 6, color: '#f43f5e', fillOpacity: 0.8 }).addTo(map);
                        activeLayers.push(marker);
                        marker.bindPopup(`<b>Waypoint</b><br>${c[0].toFixed(5)}, ${c[1].toFixed(5)}`);
                    });
                }
            });

            updateUI(allCoords, headerInfo, input);
            if (activeLayers.length > 0) {
                const group = new L.featureGroup(activeLayers);
                map.fitBounds(group.getBounds(), { padding: [40, 40] });
            }
        }

        function updateUI(coords, header, raw) {
            document.getElementById('notamInfo').classList.remove('hidden');
            document.getElementById('logArea').classList.remove('hidden');
            
            // æ—¥æœ¬æ ¼å¼å¸¸è¦‹ç¿»è­¯å°ç…§
            let translationHint = "";
            if (raw.includes("ACROBATIC")) translationHint = "ğŸš© åµæ¸¬åˆ°ç‰¹æŠ€é£›è¡Œæ´»å‹• (Acrobatic Flight)";
            if (raw.includes("GUNNERY")) translationHint = "âš ï¸ åµæ¸¬åˆ°å¯¦å½ˆå°„æ“Šè¨“ç·´ (Gunnery Training)";

            document.getElementById('infoContent').innerHTML = `
                <table class="notam-table w-full">
                    <tr><th>NOTAM ç·¨è™Ÿ</th><td>${header.id}</td></tr>
                    <tr><th>é–‹å§‹æ™‚é–“</th><td>${header.start ? `UTC: ${header.start.utc}<br>${header.start.local}` : '---'}</td></tr>
                    <tr><th>çµæŸæ™‚é–“</th><td>${header.end ? (header.end.utc || header.end) : '---'}</td></tr>
                    <tr><th>åº§æ¨™é»æ•¸</th><td>${coords.length} Points</td></tr>
                </table>
                <div class="text-[11px] text-blue-600 font-bold">${translationHint}</div>
            `;
            
            document.getElementById('coordList').innerHTML = coords.map((c, i) => `
                <div class="bg-slate-50 p-2 rounded-lg border border-slate-100 text-center shadow-sm">
                    <span class="block text-[9px] text-slate-400 font-bold">PT ${i+1}</span>
                    <span class="text-slate-700 font-mono">${c[0].toFixed(4)},${c[1].toFixed(4)}</span>
                </div>
            `).join('');
        }

        function clearAll() {
            activeLayers.forEach(l => map.removeLayer(l));
            activeLayers = [];
            document.getElementById('notamInput').value = "";
            document.getElementById('notamInfo').classList.add('hidden');
            document.getElementById('logArea').classList.add('hidden');
            map.setView([25.03, 121.5], 6);
        }
    </script>
</body>
</html>
